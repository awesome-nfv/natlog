<!DOCTYPE html><html><head>
<meta charset="UTF-8">
<title>natlog</title>
<style type="text/css">
    figure {text-align: center;}
    img {vertical-align: center;}
</style>
<link rev="made" href="mailto:Frank B. Brokken: f.b.brokken@rug.nl">
</head>
<body text="#27408B" bgcolor="#FFFAF0">
<hr/>
<h1 id="title">natlog</h1>
<h2 id="author">natlog.1.02.03.tar.gz</h2>
<h2 id="date">2012-2015</h2>

<!DOCTYPE html><html><head>
<meta charset="UTF-8">
<style type="text/css">
    figure {text-align: center;}
    img {vertical-align: center;}
    figure {text-align: center;}
    img {vertical-align: center;}
</style>
<link rev="made" href="mailto:Frank B. Brokken: f.b.brokken@rug.nl">
</head>
<body text="#27408B" bgcolor="#FFFAF0">
<hr/>
<h1 id="title"></h1>

<!DOCTYPE html><html><head>
<meta charset="UTF-8">
<title>natlog(1)</title>
<style type="text/css">
    figure {text-align: center;}
    img {vertical-align: center;}
    figure {text-align: center;}
    img {vertical-align: center;}
    figure {text-align: center;}
    img {vertical-align: center;}
</style>
<link rev="made" href="mailto:Frank B. Brokken: f.b.brokken@rug.nl">
</head>
<body text="#27408B" bgcolor="#FFFAF0">
<hr/>
<h1 id="title">natlog(1)</h1>
<h2 id="author">natlog.1.02.03.tar.gz natlog</h2>
<h2 id="date">2012-2015</h2>


<p>

<h2>NAME</h2>natlog - source-nat logging tool
<p>

<h2>SYNOPSIS</h2>
       <strong>natlog</strong> [OPTIONS] <em>command</em>
<p>
<h2>DESCRIPTION</h2>
<p>
Firewalls like <strong>iptables</strong>(1) usually offer <em>POSTROUTING</em> (source
network address translation, snat) facilities changing the source address of a
host behind the firewall to the address of the host before the firewall. With
<em>snat</em> the following combinations of IP addresses and port numbers are
encountered:
    <ul>
    <li> the IP address and port number used by the host behind the firewall
(in this manual page referred to as <em>IPsrc, sport</em>);
    <li> the IP address and port number of the host <em>IPsrc</em> connects to (in
this manual page referred to as <em>IPdst, dport</em>);
    <li> the IP address and port number used by the firewalling host when
source natting <em>IPsrc</em> and <em>sport</em> (in this manual page referred to as
<em>IPfw, fwport</em>).
    </ul>
<p>
Source natting usually uses <em>sport</em> for <em>fwport</em>, but <em>fwport</em> may
already be in use, in which case the firewalling host must use another,
available port to forward communication from <em>IPsrc, sport</em> to <em>IPdst,
dport</em>. 
<p>
The general scheme that applies to source natting, therefore, looks like
this:
        <pre>

    IPsrc:sport is translated by the firewall to IPfw:fwport;
    IPfw:fwport is used when communicating with IPdst:dport.
        
</pre>

    From the perspective of the destination host the communication originates
at <em>IPfw::fwport</em> and consequently all communication (e.g., and incident
report) sent by the systems administrator maintaining <em>IPdst</em> to <em>IPfw</em>'s
systems administrator will refer to <em>IPfw:fwport</em>, rather than to
<em>IPsrc::sport</em>.
<p>
The standard log facilities provided by <em>iptables</em> do not easily allow
us to relate <em>IPfw:fwport</em> to <em>IPsrc:sport</em>, and <em>natlog</em> was developed
to fill in that particular niche.
<p>
When running <em>natlog</em>, messages are sent to the syslog daemon (e.g.,
<strong>rsyslogd</strong>(1)) and/or the standard output stream showing the essential
characteristics of the connection using source natting. Here is an example:
        <pre>

    NATLOG: (TCP) From 1338990672:55588 until 1338990747:807100:     
    192.168.19.72:4467 (via: 129.125.90.132:4467) to 200.49.219.180:443
        
</pre>

    In this example the values <em>1338990672:55588</em> and <em>1338990747:807100</em>
represent time stamps showing the begin- and end-times in seconds:microseconds
of a TCP connection since Jan 1, 1970, 0:00 UTC. <em>Natlog</em> offers the
<em>--datetime</em> option, resulting in time representations like <em>Nov 2
13:29:11</em> rather than time representations using seconds and micro seconds.
<p>
The next value (<em>192.168.19.72:4467</em>) represents <em>IPsrc::sport</em>. This
is followed by <em>129.125.90.132:4467</em>, representing <em>IPfw:fwport</em>. The
third pair of values (<em>200.49.219.180:443</em>) represents <em>IPdst:dport</em>. 
<p>
In this example, host <em>192.168.19.72</em>, using port <em>4467</em>, connected to
host <em>200.49.219.180</em>, port <em>443</em>. To this latter host the connection
appeared to have originated from <em>129.125.90.132</em> port <em>4467</em>. The
provided log message easily allows us to related this to the `real' host and
port from which the connection originated: <em>192.168.19.72:4467</em>.
<p>
When <em>natlog</em> terminates <em>natlog</em> can no longer track connections that
are still open. If <em>natlog</em> was terminated by a <em>SIGTERM</em> signal, then it
sends a `terminating' line to syslog, followed by an overview of all still
open connections. The end-microseconds values of connections that are no
longer tracked are shown as <em>0000</em>.
<p>
<h2>COMMANDS</h2>
<p>
<ul>
    <li> <em>conntrack</em>: this command can only be used on platforms using
<strong>iptables</strong>(1) on which <strong>conntrack</strong>(1) has also been installed. Information
about source-natted connections is obtained from <strong>conntrack</strong>(1)'s
output. With this command the TCP, UDP, and ICMP layer four protocols can be
monitored (by default the TCP protocol is monitored). See also the
<em>conntrack-command</em> option.
<p>
<li> <em>indevice outdevice</em>: <em>indevice</em> is the name of the device behind
the firewall. Addresses living behind the <em>indevice</em> are source-natted to
the firewall's IP address when passed on to the <em>outdevice</em>; <em>outdevice</em>
is the name of the device to which source-natted packets are forwarded,
c.q. from where replies for source-natted hosts living behind the <em>indevice</em>
are received. Currently, this command is only available for tracking TCP
connections. 
    </ul>
<p>
<h2>OPTIONS</h2>
<p>
<ul>
    <li> <strong>--config</strong>=<em>config-path</em> (<strong>-c</strong>)<br/>
       The argument <em>config-path</em> defines the path to the configuration file
        to be used by <em>natlog</em>. By default the configuration file is
        expected in <em>/etc/natlog.conf</em>. All configuration options have
        defaults, which are used when no configuration file and no
        command-line options are provided. 
<p>
All options, except for <em>config, help</em> and <em>verbose</em> can also be
        specified in the configuration file. The configuration file ignores
        empty lines and all information on lines beginning with a hash-mark
        (<em>#</em>). In the configuration file option names do not use initial
        hyphens, and may immediately be followed by a colon. Multi-word
        arguments should not be surrounded by quotes. Examples: 
            <pre>

    stdout
    syslog-facility: LOCAL0
            
</pre>

       Command-line options override configuration file options.
<p>
<li> <strong>--conntrack-command</strong>=<em>path [options]</em><br/>
       The path and options to the <strong>conntrack</strong>(1) program. By default this
        is <em>/usr/sbin/conntrack -p tcp -E -n -o timestamp -e NEW,DESTROY</em>,
        resulting in:<br/>
<p>
- Monitoring the TCP layer four protocol;<br/>
       - Displaying real-time event logs (<em>-E</em>);<br/>
       - Displaying time stamps (<em>-o timestamp</em>);<br/>
       - Logging all new and destroyed (ended) events (<em>-e
            NEW,DESTROY</em>);<br/>
<p>
The protocols to monitor can separately be configured using the
        <em>--protocol</em> option.
<p>
The <em>conntrack</em> program must be available when requesting
        <em>natlog</em>'s <em>conntrack</em> command. Layer four protocols other than
        TCP, UDP and ICMP are currently not supported. A subset of the
        supported protocols may be requested using <em>conntrack's -p tcp, -p
        udp</em> or <em>-p icmp</em> options.
<p>
<li> <strong>--conntrack-restart</strong>=<em>max</em><br/>
       If the conntrack process prematurely ends it is restarted at most
        <em>max</em> times (these are pure <em>restarts</em>: conntrack's initial
        startup is not counted for this option). By default 10 restarts are
        allowed.
<p>
<li> <strong>--help</strong> (<strong>-h</strong>)<br/>
       Write basic usage information to the standard output stream and
        terminate.
<p>
<li> <strong>--no-daemon</strong><br/>
       By default, <em>natlog</em> runs in the background (a daemon). <em>Natlog</em>
        runs as an ordinary program (i.e., in the foreground when the option
        <em>no-daemon</em> is provided). When running as a daemon, <em>--stdout</em>
        (see below) is suppressed, and <em>--verbose</em> messages (see below) are
        sent to the sylog daemon, unless <em>--no-syslog</em> was specified.
<p>
<li> <strong>--no-syslog</strong><br/>
       By default <em>natlog</em> writes syslog messages to the <em>DAEMON</em> facility
        with priority <em>NOTICE</em>. No messages are sent to the syslog daemon
        when this option is specified.
<p>
<li> <strong>--pid-file</strong>=<em>path</em> (<strong>-p</strong>)<br/>
       When <em>natlog</em> runs in the background, then <em>path</em> is the name of
        the path of the file holding the daemon's process-id. By default this
        is <em>/run/natlog.pid</em>. To end the daemon, send a SIGTERM signal to
        the process id mentioned in the <em>pid-file</em>. <em>Natlog</em> ignores
        <em>SIGHUP</em> signals (but writes a log message if a <em>SIGHUP</em> interrupt
        is received).
<p>
<li> <strong>--protocol</strong>=<em>specification</em> (<strong>-P</strong>)<br/>
       The protocols to monitor by <strong>conntrack</strong>(1). By default
        <em>conntrack-command</em> monitors the TCP layer four protocol. Currently
        <em>natlog's conntrack</em> command can monitor the TCP, UDP, and ICMP
        layer four protocols.  Using the <em>protocol</em> option (note: singular!)
        any subset of these protocols can be selected by specifying a
        colon-separated subset of TCP, UDP, and ICMP (e.g., <em>--protocol
        udp:tcp</em>). The specification <em>all</em> can be used to monitor all three
        protocols: TCP, UDP, and ICMP.
<p>
If the <em>conntrack-command</em> option is specified, the <em>protocol</em>
        option is ignored.
<p>
<li> <strong>--stdout</strong> (<strong>-s</strong>)<br/> 
       Syslog-equivalent messages are sent to the standard output.
        This option is implied by <em>--verbose</em>, but is suppressed when
        <em>natlog</em> runs as a daemon..
<p>
<li> <strong>--syslog-facility</strong>=<em>facility</em><br/>
       The facility that is used to write the syslog messages to. By default
        this is <em>DAEMON</em>. For an overview of facilities and their meanings,
        see, e.g., <strong>syslog</strong>(3). With <em>natlog</em> the facilities <em>DAEMON,
        LOCAL0, LOCAL1, LOCAL2, LOCAL3, LOCAL4, LOCAL5, LOCAL6, LOCAL7</em>, and
        <em>USER</em> can be used.
<p>
<li> <strong>--syslog-priority</strong>=<em>priority</em><br/>
       The priority that is used to write the syslog messages to. By default
        this is <em>NOTICE</em>. For an overview of priorities and their meanings,
        see, e.g., <strong>syslog</strong>(3). With <em>natlog</em> all defined priorities can
        be used. E.g., <em> EMERG, ALERT, CRIT, ERR, WARNING, NOTICE, INFO</em> and
        <em>DEBUG</em>.
<p>
<li> <strong>--syslog-tag</strong>=<em>tag</em><br/>
       When syslog messages are generated they can be provided with a
        <em>tag</em>, which can be used to filter <em>natlog</em>'s syslog messages from
        the log-files. By default the tag <em>NATLOG</em> is used. See also section
        <em>RSYSLOG FILTERING</em> below.
<p>
<li> <strong>--time</strong>=<em>spec</em> (<strong>-t</strong>)<br/>
        By default time stamps written by <em>natlog</em> are in raw, numeric
        form. E.g.,
        <pre>

NATLOG: From 1338990672:55588 until 1338990747:807100
        
</pre>

       These time stamps indicate times in seconds:microseconds since the
        beginning of the epoch, January 1, 1970, 0:00 UTC. This option can be
        used to change the seconds part of the time stamps to more
        conventional representations.<br/>
       Specify <em>raw</em> (the default) for the default representation in seconds
        since the epoch; <br/>
       specify <em>utc</em> for a representation like <em>Jun 6 13:29:11</em>, using
        Universal Time Coordinated;<br/>
       specify <em>local</em> for a representation like <em>Jun 6 13:29:11</em>, using
        the local time zone defined by the computer running <em>natlog</em>.
<p>
<li> <strong>--verbose</strong><br/> 
       Additional messages about <em>natlog</em>'s mode of operation are sent to
        the standard output stream. When <em>natlog</em> runs as a daemon these
        messages are sent to the syslog daemon, unless <em>--no-syslog</em> was
        specified. 
<p>
<li> <strong>--version</strong> (<strong>-v</strong>)<br/> 
       Write <em>natlog</em>'s version number to the standard output stream and
        terminate.
<p>
<li> <strong>--warn</strong> (<strong>-w</strong>)<br/> 
       Warn about terminating connections not yet registered in <em>natlog</em>'s
        database. This normally only happens during a short period after
        starting <em>natlog</em>, when existing connections haven't yet been
        noticed. 
    </ul>
<p>
<h2>RSYSLOG FILTERING</h2>
<p>
When using <strong>rsyslogd</strong>(1) property based filters may be used to filter
syslog messages and write them to a file of your choice. E.g., to filter
messages starting with the syslog message tag (e.g., <em>NATLOG</em>) use
        <pre>

:syslogtag, isequal, "NATLOG:"   /var/log/natlog.log
:syslogtag, isequal, "NATLOG:"   stop
        
</pre>

    Note that the colon is part of the tag, but is not specified with the 
<em>syslog-tag</em> option.
<p>
This causes all messages having the <em>NATLOG:</em> tag to be written on
<em>/var/log/natlog.log</em> after which they are discarded. More extensive
filtering is also supported, see, e.g.,
<em>http://www.rsyslog.com/doc/rsyslog_conf_filter.html</em> and
<em>http://www.rsyslog.com/doc/property_replacer.html</em>
<p>
<h2>EXAMPLES</h2>
<p>
Examples of <em>natlog</em> activations:
    <ul>
    <li> <em>natlog --no-daemon --no-syslog -s tun0 eth0</em><br/>
        <em>Natlog</em> remains active as a foreground process, no syslog messages
are written, syslog-equivalent message are written to the standard
output. <em>Natlog</em> uses the pcap library to capture packets from the <em>tun0</em>
device (e.g., an <strong>openvpn</strong>(1) device), which is active behind the firewall,
and to capture packets from the <em>eth0</em> device, which is the device to where
source-natted packages are sent.
<p>
<li> <em>natlog conntrack</em><br/>
        Depending on the options specified in <em>/etc/natlog.conf</em> (or, if not
available, <em>natlog</em>'s default options) source-natted connections are
obtained from <strong>conntrack</strong>(1). By default <em>natlog</em> continues as a daemon
process, generating syslog messages using syslog tags <em>NATLOG:</em>, and
containing information about source-natted connections.
    </ul>
<p>
Here is <em>natlog</em>'s default configuration file. Empty lines and lines
starting with hash-marks (#) are ignored. Options adhere to the following
syntax: 
    <pre>

option  value 
    
</pre>

    Option and value are separated by white space, a colon may be appended to
option names, and option values may consist of multiple words.
    <pre>
# This configuration file shows the default option values.

# all options and values are case sensitive
# see `man natlog' for further details

    # the path and options of the conntrack program:
    # when no filtering options are specified, the tcp
    # protocol is monitored
    # the default command is shown:
#conntrack-command:  /usr/sbin/conntrack -p tcp -E -n -o timestamp -e NEW,DESTROY"

    # the protocols that are scanned with the 'conntrack' command:
    #   protocol: all       - monitors tcp, udp, icmp
    #   protocol: udp:tcp   - monitors upd and tcp (any non-empty subset, 
    #                         possibly including icmp is OK)
    # ignored when conntrack-command is specified
#protocol: tcp

    # the default syslog tag:
#syslog-tag: NATLOG

    # the default syslog facility:
#syslog-facility: DAEMON

    # the default syslog priority:
#syslog-priority: NOTICE

    # the time specification:
#time: raw

    # the path to the pid-file of natlog's daemon process
#pid-file: /var/natlog.pid

# end of the configuration file



</pre>

<p>
<h2>FILES</h2>
    <ul>
    <li> <em>/etc/natlog.conf</em>: default configuration file.
    </ul>
<p>
<h2>SEE ALSO</h2>
<p>
<strong>conntrack</strong>(1), <strong>iptables</strong>(1), <strong>rsyslogd</strong>(1), <strong>syslog</strong>(3)
<p>
<h2>BUGS</h2>
<p>
The <em>conntrack</em> command currently only supports the TCP, UDP and ICMP
layer four protocols.
<p>
The <em>indevice outdevice</em> command currently only supports the TCP
protocol.
<p>
<h2>AUTHOR</h2>
<p>
Frank B. Brokken (f.b.brokken@rug.nl).
<p>
